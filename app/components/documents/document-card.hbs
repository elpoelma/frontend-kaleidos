<div
  class="vlc-document-card {{if (not this.bordered) 'vlc-document-card--borderless'}} {{if this.documentContainer.aboutToDelete 'vlc-document--deleted-state'}}"
  {{did-update (perform this.loadPieceRelatedData) @piece}}
  {{did-update (perform this.loadPieceRelatedData) @documentContainer}}
  data-test-document-card
>
  <div class="vlc-document-card__summary">
    <div class="vlc-document-card__content">
      <Auk::Toolbar @auto={{true}} as |Toolbar|>
        <Toolbar.Group @position="left" as |Group|>
          <Group.Item>
            {{#if @isHighlighted}}
              <Auk::Badge @skin="success" @icon="document-added" @size="large" />
            {{else}}
              <Auk::Badge @icon="document" @size="large" />
            {{/if}}
          </Group.Item>
          <Group.Item class="auk-u-maximize-width">
            {{#if @nameMockup}}
            <div class="auk-o-flex auk-o-flex--vertical-center auk-o-flex--spaced">
              <span data-test-document-card-type class="auk-overline">
                {{#unless this.loadPieceRelatedData.isRunning}}
                  {{this.documentContainer.type.label}}
                {{/unless}}
              </span>
              <span class="auk-overline">
                {{slice-text this.piece.name start=8 limit=2}}-{{slice-text this.piece.name start=10 limit=2}}-{{slice-text this.piece.name start=3 limit=4}}
              </span>
              <span class="auk-overline">
                {{#if this.piece.file}}{{uppercase this.piece.file.extension}}{{/if}}
              </span>
            </div>
            <LinkTo @route="document" @model={{this.piece.id}}
              class="auk-h4 au-u-flex au-u-flex--vertical-center au-u-flex--spaced-tiny" data-test-document-card-name-value>
              {{#if (eq this.documentContainer.type.label "Nota")}}
                {{slice-text this.piece.name start=12 limit=11}} <AuPill @skin="ongoing" @size="small">BIS</AuPill> -  {{slice-text this.piece.name start=23 limit=50 removeType=true}}
              {{else}}
                {{slice-text this.piece.name start=12 limit=11}} -  {{slice-text this.piece.name start=23 limit=50 removeType=true}}
              {{/if}}
            </LinkTo>
            {{else}}
            <LinkTo @route="document" @model={{this.piece.id}}
              class="auk-h4 au-u-flex au-u-flex--vertical-center au-u-flex--spaced-tiny" data-test-document-card-name-value>
                {{this.piece.name}} - {{slice-text this.piece.name start=23 limit=50 removeType=true}}
            </LinkTo>
            {{/if}}
            <div class="vlc-document-card-content__meta au-u-margin-top-tiny">
              {{! no piece.created in legacy data }}
              {{#if (or (eq this.piece.file.extension "docx") (eq this.piece.file.extension "doc"))}}
                <p data-test-document-card-primary-source-created>
                  {{t "uploaded-at"}}
                  {{moment-format this.piece.created}}
                  {{t "at"}}
                  {{moment-format this.piece.created "HH:mm"}}
                  {{t "as"}}
                  <AuLinkExternal
                    data-test-document-card-primary-source-link
                    href={{this.piece.file.primarySource.namedDownloadLink}}
                    download
                  >
                    {{t (if (or (eq this.piece.file.extension "docx") (eq this.piece.file.extension "doc")) "word-document" "source-file-lowercase")}}
                  </AuLinkExternal>
                </p>
              {{else}}
                {{#if this.piece.created}}
                  <p>
                    {{t "uploaded-at"}}
                    {{moment-format this.piece.created}}
                    {{t "at"}}
                    {{moment-format this.piece.created "HH:mm"}}
                  </p>
                {{/if}}
              {{/if}}
              {{#if (eq @signatureMockupAlt true)}}
              <p><AuLinkExternal>Getekend document</AuLinkExternal> op {{moment-format this.piece.created}} {{t "at"}} {{moment-format this.piece.created "HH:mm"}}</p>
              {{/if}}
            </div>
          </Group.Item>
        </Toolbar.Group>
        <Toolbar.Group @position="right" as |Group|>
          {{#if
            (and
              (user-may "manage-publication-flows")
              (not this.loadPieceRelatedData.isRunning)
              (not this.loadPublicationFlowRelatedData.isRunning)
            )
          }}
            {{#if this.piece.publicationFlow}}
              <AuPill
                @size="small"
                @route="publications.publication"
                @model={{this.piece.publicationFlow.id}}
                data-test-document-card-publication-link
              >
                {{this.piece.publicationFlow.identification.idName}}
              </AuPill>
            {{/if}}
          {{/if}}
          <Group.Item
            class="auk-o-flex"
            {{did-update (perform this.loadAccessLevelRelatedData) @agendaContext.meeting.internalDecisionPublicationActivity.status}}
            {{did-update (perform this.loadAccessLevelRelatedData) @agendaContext.meeting.internalDocumentPublicationActivity.status}}
            {{did-update (perform this.loadAccessLevelRelatedData) @agendaContext.agenda.status}}
            {{did-update (perform this.loadAccessLevelRelatedData) @agendaContext.agenda.previousVersion}}
          >
            {{#unless this.loadAccessLevelRelatedData.isRunning}}
              <AccessLevelPill
                @accessLevel={{this.piece.accessLevel}}
                @isDraft={{this.isDraftAccessLevel}}
                @isEditable={{true}}
                @onChangeAccessLevel={{this.changeAccessLevel}}
                @onConfirmChangeAccessLevel={{this.saveAccessLevel}}
                @onCancelChangeAccessLevel={{this.reloadAccessLevel}}
              />
            {{/unless}}
          </Group.Item>
          {{#if this.signaturesEnabled}} {{! feature flag }}
            {{#if this.loadSignatureRelatedData.isRunning }}
              <div class="auk-loader au-u-margin-left-small" role="alert" aria-busy="true"></div>
            {{/if}}
            {{#if this.markOrUnmarkForSignature.isRunning }}
              <div class="auk-loader au-u-margin-left-small" role="alert" aria-busy="true"></div>
            {{/if}}
            
            {{#if this.loadPieceRelatedData.isRunning }}
              <div class="auk-loader au-u-margin-left-small" role="alert" aria-busy="true"></div>
            {{/if}}
            {{#if
              (and
                (user-may "manage-signatures")
                (not this.loadSignatureRelatedData.isRunning)
                (not this.loadPieceRelatedData.isRunning)
              )
            }}
              <Group.Item>
                {{#if (or (eq this.signatureRequested true) @signatureMockupAlt)}}
                <SignaturePill
                  @isLoading={{his.loadPieceRelatedData.isRunning}}
                  @isEditable={{true}}
                  @signatureMockupAlt={{@signatureMockupAlt}}
                />
                {{else if (or (eq this.signatureRequested true) @signatureMockup)}}
                <SignaturePill
                  @isLoading={{his.loadPieceRelatedData.isRunning}}
                  @isEditable={{true}}
                  @signatureMockup={{@signatureMockup}}
                />
                {{else}}
                {{/if}}
              </Group.Item>
            {{else}}
              {{#if (eq this.signatureRequested true)}}
              <Group.Item>
                <SignaturePill
                  @isLoading={{his.loadPieceRelatedData.isRunning}}
                  @isEditable={{false}}
                />
              </Group.Item>
              {{/if}}
            {{/if}}
          {{/if}}
          {{#if (user-may "manage-documents")}}
            <Group.Item>
              <AuDropdown
                data-test-document-card-actions={{true}}
                @icon="three-dots"
                @title={{t "more"}}
                @hideText={{true}}
                @disabled={{this.loadPieceRelatedData.isRunning}}
                @alignment="right"
              >
                <AuButton
                  data-test-document-upload-new-piece
                  @skin="link"
                  {{on "click" this.openUploadModal}}
                  role="menuitem"
                >
                  {{t "new-version"}}
                </AuButton>
                <AuButton
                  data-test-document-edit-piece
                  @skin="link"
                  {{on "click" (toggle "isEditingPiece" this)}}
                  role="menuitem"
                >
                  {{t "edit"}}
                </AuButton>
                {{#if (or @signatureMockup @signatureMockupAlt)}}
                {{else}}
                <AuHr />
                <AuButton
                  @skin="link"
                  {{on "click" (perform this.markOrUnmarkForSignature)}}
                  role="menuitem"
                >
                  {{#if (eq this.signatureRequested true)}}
                    Verwijderen van handtekenen
                  {{else}}
                    Aanbieden voor handtekenen 
                  {{/if}}
                </AuButton>
                {{/if}}
                <AuHr />
                <AuButton
                  data-test-document-card-delete
                  @skin="link"
                  @alert={{true}}
                  {{on "click" this.deleteDocumentContainer}}
                  role="menuitem"
                >
                  {{t "document-delete"}}
                </AuButton>
              </AuDropdown>
            </Group.Item>
          {{/if}}
        </Toolbar.Group>
      </Auk::Toolbar>
    </div>
  </div>
  {{#if (user-may "view-document-version-info")}}
    {{#if (gt this.visiblePieces.length 0)}}
      <div class="vlc-document-card-versions">
        <Auk::Accordion>
          <Auk::Accordion::Item
            @title={{t "previous-versions"}}
            @disabled={{this.loadPieceRelatedData.isRunning}}
            @expandTask={{this.loadVersionHistory}}
            data-test-document-card-version-history
          >
            {{#if this.loadVersionHistory.isRunning}}
              <div class="auk-u-p-3">
                <Auk::Loader />
              </div>
            {{else}}
              {{#each this.visiblePieces as |piece|}}
                <div
                  class="vlc-document-holder"
                  {{did-update (perform this.loadPieceRelatedData) piece}}
                >
                  {{#if (eq @signatureMockupAlt true)}}
                  <div class="vlc-document-card-item">
                    <div class="vlc-document-card-item__title">
                      {{#if piece.file}}
                        <LinkTo @route="document" @model={{piece.id}}
                          class="auk-h4 auk-u-m-0 auk-u-mr-4 vlc-document-card-item__title-link"
                          data-test-vl-document-name>
                          {{piece.name}}{{#if piece.file}}.{{piece.file.extension}}{{/if}}
                        </LinkTo>
                      {{else}}
                        <h6
                          class="auk-h4 auk-u-m-0 auk-u-mr-4 vlc-document-card-item__title-link"
                          data-test-vl-document-name
                        >
                          <EmberTooltip @side="bottom" @tooltipClass="auk-tooltip">
                            {{t "document-not-consultable"}}
                          </EmberTooltip>
                          {{piece.name}}{{#if piece.file}}.{{piece.file.extension}}{{/if}}
                        </h6>
                      {{/if}}
                      <div class="auk-o-flex auk-o-flex--spaced auk-o-flex--vertical-center">
                        <AuPill @icon="sign">Getekend</AuPill>
                        <AuPill
                          @skin="warning"
                          @icon="circle"
                        >
                          Intern regering
                        </AuPill>
                      </div>
                    </div>
                    <div class="vlc-document-card-item__meta au-u-muted">
                      {{!-- no piece.created in legacy data --}}
                      {{#if piece.created}}
                        {{t "uploaded-at"}}
                        {{moment-format piece.created}}
                        {{t "at"}}
                        {{moment-format piece.created "HH:mm"}}
                      {{/if}}
                    </div>
                    <div class="vlc-document-card-item__icon">
                      <Auk::Icon @name="clock-rewind" @size="small" />
                    </div>
                  </div>
                  {{/if}}
                  <Documents::DocumentVersionHistoryItem
                    @piece={{piece}}
                    @agendaContext={{@agendaContext}}
                    @onChangeAccessLevel={{fn this.changeAccessLevelOfPiece piece}}
                    @onConfirmChangeAccessLevel={{fn this.saveAccessLevelOfPiece piece}}
                    @onCancelChangeAccessLevel={{this.reloadAccessLevel}}
                  />
                </div>
              {{/each}}
            {{/if}}
          </Auk::Accordion::Item>
        </Auk::Accordion>
      </div>
    {{/if}}
  {{/if}}
</div>
{{#if this.isEditingPiece}}
  <Documents::DocumentCard::EditModal
    @piece={{this.piece}}
    @onCancel={{toggle "isEditingPiece" this}}
    @onSave={{toggle "isEditingPiece" this}}
  />
{{/if}}

{{#if this.isOpenUploadModal}}
  <WebComponents::VlModal
    @closeModal={{perform this.cancelUploadPiece}}
    @isOverlay={{true}}
    @title={{t "new-document-piece"}}
  >
    <Auk::Modal::Body>
      {{#if this.newPiece}}
        <Auk::Label>{{t "name"}}</Auk::Label>
        <AuInput @width="block" @value={{this.newPiece.name}} />
        <Documents::UploadedDocument
          @piece={{this.newPiece}}
          @onDelete={{perform this.deleteUploadedPiece}}
        />
      {{else}}
        <Auk::FileUploader @onUpload={{perform this.uploadPiece}} />
      {{/if}}
    </Auk::Modal::Body>
    <WebComponents::VlModalFooter
      @cancelButtonText={{t "cancel"}}
      @saveButtonText={{t "add"}}
      @isLoading={{this.addPiece.isRunning}}
      @cancelAction={{perform this.cancelUploadPiece}}
      @saveAction={{perform this.addPiece}}
      @disableSave={{not this.newPiece}}
    />
  </WebComponents::VlModal>
{{/if}}
{{#if this.isOpenVerifyDeleteModal}}
  <WebComponents::VlModalVerify
    @title={{t "document-container-delete"}}
    @message={{t "delete-document-container-message"}}
    @cancel={{this.cancelDeleteDocumentContainer}}
    @verify={{this.verifyDeleteDocumentContainer}}
  />
{{/if}}