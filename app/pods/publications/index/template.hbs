<WebComponents::AuNavbar class="auk-publication-overview-navbar" @border="bottom" @skin="gray-100" @auto="true">
  <WebComponents::AuToolbar>
    <WebComponents::AuToolbar::Group @position="left">
      <WebComponents::AuToolbar::Item>
        <div class="auk-u-flex auk-u-flex--vertical">
          <h4 class="auk-toolbar-complex__title">{{t "publications" }}</h4>
        </div>
      </WebComponents::AuToolbar::Item>
    </WebComponents::AuToolbar::Group>
    <WebComponents::AuToolbar::Group @position="right">
      <WebComponents::AuToolbar::Item>
        <WebComponents::AuDropdown>
          <Publications::PublicationCaseSearch/>
        </WebComponents::AuDropdown>
      </WebComponents::AuToolbar::Item>
      <WebComponents::AuToolbar::Item>
        <WebComponents::AuButton @skin="secondary" @icon="filter" {{on "click" (fn this.showFilterModal)}}>
          {{t "filter-content"}}
        </WebComponents::AuButton>
      </WebComponents::AuToolbar::Item>

      <WebComponents::AuToolbar::Item>
        <WebComponents::AuButton data-test-publication-header-button-new @icon="add" @skin="primary" {{on "click"
                                                                                                          (fn this.showPublicationModal)}}>
          {{t "publications-new"}}
        </WebComponents::AuButton>
      </WebComponents::AuToolbar::Item>
    </WebComponents::AuToolbar::Group>
  </WebComponents::AuToolbar>
</WebComponents::AuNavbar>
<div class="auk-scroll-wrapper auk-publication-table">
  <div class="auk-scroll-wrapper__body">
    <div class="auk-u-m-4">
      <table class="auk-table auk-table--styled auk-table--bordered js-data-table">
        <thead>
          <tr>
            {{#each this.tableColumns as |column|}}
              {{#if (get this.tableColumnDisplayOptions column.keyName)}}
            {{!-- first cases that need a special treament. The "else" clause treats the default case --}}
                {{#if (eq column.keyName "caseName")}}
                  <ThSortable
                        @currentSorting={{this.sort}}
                        @field={{column.keyName}}
                        @label={{t column.translationKeySmall}}
                        @class="auk-u-text-nowrap auk-case-name-header"/>
                {{else}}
                  {{#if column.sortable}}
                    <ThSortable
                          @currentSorting={{this.sort}}
                          @field={{column.keyName}}
                          @label={{t column.translationKeySmall}}
                          @class="auk-u-text-nowrap"/>
                  {{else}}
                    <th class="auk-u-text-nowrap">{{t column.translationKeySmall}}</th>
                  {{/if}}
                {{/if}}
              {{/if}}
            {{/each}}
            <th>&nbsp;</th>
          </tr>
        </thead>
        <tbody>
          {{#each this.model as |row|}}
            <tr >
              {{#if this.tableColumnDisplayOptions.caseName}}
            {{!-- There is legacy data were case does not have a shortTitle, we have to fall back to title --}}
                <td class="auk-table__col--6">
                  {{#if row.case.shortTitle}}
                    <WebComponents::AuAbbreviatedText @text={{row.case.shortTitle}} @size="150"/>
                  {{else}}
                    {{#if row.case.title}}
                      <WebComponents::AuAbbreviatedText @text={{row.case.title}} @size="150"/>
                    {{else}}
                      {{t "dash"}}
                    {{/if}}
                  {{/if}}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.speedProcedure}}
                <td class="auk-u-text-align--center">
                  {{#if row.urgencyLevel.isUrgent}}
                    <WebComponents::AuIcon @iconSkinColor="warning" @name="alert-triangle"/>
                    <EmberTooltip @tooltipClass="auk-tooltip" @side="bottom">
                      <p>
                        {{t "priority-procedure"}}
                      </p>
                    </EmberTooltip>
                  {{else}}
                    {{t "dash"}}
                  {{/if}}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.decisionDate}}
                <td>
                  {{t "dash"}}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.publicationNumber}}
                <td>
                  {{#if row.publicationNumber}}
                    {{row.publicationNumberToDisplay}}
                  {{else}}
                    {{t "dash"}}
                  {{/if}}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.regulationType}}
                <td>
                  {{#if row.regulationType}}
                    {{row.regulationType.label}}
                  {{else}}
                    {{t "dash"}}
                  {{/if}}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.numacNumber}}
                <td>
                  {{#each row.numacNumbers as |numac|}}
                    <WebComponents::AuPill>{{numac.name}}</WebComponents::AuPill>
                  {{else}}
                    {{t "dash"}}
                  {{/each}}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.requestedPublicationDate}}
                <td class="auk-u-text-nowrap">
                  {{#if row.publishDateRequested}}
                    {{moment-format row.publishDateRequested "DD-MM-YYYY"}}
                  {{else}}
                    {{t "dash"}}
                  {{/if}}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.publicationDate}}
                <td class="auk-u-text-nowrap">
                  {{if row.publishedAt (moment-format row.publishedAt "DD-MM-YYYY") (t "dash") }}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.withdrawnDate}}
                <td class="auk-u-text-nowrap">
                  {{#if row.status.isWithdrawn }}
                    {{moment-format row.publicationStatusChange.startedAt "DD-MM-YYYY"}}
                    <br/>
                    <span class="auk-u-text-small auk-u-muted">
                      {{moment-format row.publicationStatusChange.startedAt "HH:mm"}}
                    </span>
                  {{else}}
                    {{t "dash"}}
                  {{/if}}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.pauseDate}}
                <td class="auk-u-text-nowrap">
                  {{#if row.status.isPaused}}
                    {{moment-format row.publicationStatusChange.startedAt "DD-MM-YYYY"}}
                    <br/>
                    <span class="auk-u-text-small auk-u-muted">
                      {{moment-format row.publicationStatusChange.startedAt "HH:mm"}}
                    </span>
                  {{else}}
                    {{t "dash"}}
                  {{/if}}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.translateRequests}}
                <td class="auk-u-text-align--center">
                  {{#if (gt (await row.translationRequestsTotal) 0)}}
                    {{#if
                      (eq (await row.translationRequestsFinished) (await row.translationRequestsTotal))
                    }}
                      <WebComponents::AuStatusPill @status="done">
                        {{await row.translationRequestsFinished}} / {{await row.translationRequestsTotal}}
                      </WebComponents::AuStatusPill>
                    {{else}}
                      <WebComponents::AuStatusPill @status="in-progress">
                        {{await row.translationRequestsFinished}} / {{await row.translationRequestsTotal}}
                      </WebComponents::AuStatusPill>
                    {{/if}}
                  {{else}}
                    <WebComponents::AuStatusPill @status="not-started"/>
                  {{/if}}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.publishPreviewRequests}}
                <td class="auk-u-text-align--center">
                  {{#if (gt (await row.publishpreviewRequestsTotal) 0)}}
                    {{#if
                      (eq (await row.publishpreviewRequestsFinished) (await row.publishpreviewRequestsTotal))
                    }}
                      <WebComponents::AuStatusPill @status="done">
                        {{await row.publishpreviewRequestsFinished}} / {{await row.publishpreviewRequestsTotal}}
                      </WebComponents::AuStatusPill>
                    {{else}}
                      <WebComponents::AuStatusPill @status="in-progress">
                        {{await row.publishpreviewRequestsFinished}} / {{await row.publishpreviewRequestsTotal}}
                      </WebComponents::AuStatusPill>
                    {{/if}}
                  {{else}}
                    <WebComponents::AuStatusPill @status="not-started"/>
                  {{/if}}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.publishPreviewReady}}
                <td class="auk-u-text-align--center">
                  <WebComponents::AuStatusPill @status="not-started"/>
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.lastEdited}}
                <td class="auk-u-text-nowrap">
                  {{moment-format row.modified "DD-MM-YYYY"}}<br/>
                  <span class="auk-u-text-small auk-u-muted">
                    {{moment-format row.modified "HH:mm"}}
                  </span>
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.lastEditedBy}}
                <td>
                  {{t "dash"}}
                </td>
              {{/if}}
              {{#if this.tableColumnDisplayOptions.comment}}
                <td class="auk-u-text-align--center">
                  {{#if row.remark}}
                    <WebComponents::AuIcon @iconSkinColor="muted" @name="comment"/>
                    <EmberTooltip @tooltipClass="auk-tooltip" @side="bottom">
                      <p>
                        {{row.remark}}
                      </p>
                    </EmberTooltip>
                  {{else}}
                    {{t "dash"}}
                  {{/if}}
                </td>
              {{/if}}
              <td>
                <LinkTo  @route="publications.publication"
                         @model={{row.id}} class="auk-button auk-button--borderless auk-button--icon">
                  <i class="ki ki-chevron-right"></i>
                </LinkTo>
              </td>
            </tr>
          {{else}}
            <tr>{{t "no-results-found"}}</tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>
</div>
<div>
  <hr>
</div>
<div class="auk-u-mx-4">
  <div class="auk-toolbar-complex">
    <div class="auk-toolbar-complex__left">
      <div class="auk-toolbar-complex__item">
        {{!-- TODO Fix pagination --}}
        <WebComponents::VlPagination
                @page={{this.page}}
                @nbOfItems={{this.model.length}}
                @size={{this.size}}
                @nextAction={{this.nextPage}}
                @previousAction={{this.prevPage}}
                @total={{this.model.meta.count}} />
      </div>
    </div>
    <div class="auk-toolbar-complex__right">
      <div class="auk-toolbar-complex__item">
        <div class="auk-pagination__container">
          <p class="auk-pagination__fontsize auk-pagination-nowrap">{{t "amount-showed"}}</p>
          <PowerSelect
                    @searchEnabled={{false}}
                    @placeholder={{t "select-a-status"}}
                    @options={{this.sizeOptions}}
                    @selected={{this.size}}
                    @onchange={{ action 'setSizeOption'}}
                    as |option|>
            {{option}}
          </PowerSelect>
        </div>
      </div>
      <div class="auk-toolbar-complex__item">
        <WebComponents::AuButton @icon="settings" @skin="borderless" data-test-publication-button-filter-tables
          {{on "click" this.openColumnDisplayOptionsModal}}
        />
      </div>
    </div>
  </div>
</div>

{{#if this.isShowPublicationModal}}
  <Publications::NewPublicationModal
          @onCancel={{this.closePublicationModal}}
          @onSave={{this.saveNewPublication}} />
{{/if}}
{{#if this.isShowPublicationFilterModal}}
  <Publications::PublicationsFilterModal
          @filter={{this.publicationFilter}}
          @onCancel={{this.cancelPublicationsFilter}}
          @onSave={{this.savePublicationsFilter}} />
{{/if}}
{{#if this.showTableDisplayOptions}}
  <Publications::OverviewTableDisplayConfigModal
          @options={{this.tableColumnDisplayOptions}}
          @onChange={{this.changeColumnDisplayOptions}}
          @onClose={{this.closeColumnDisplayOptionsModal}}
  />
{{/if}}

{{!-- LOADER --}}
{{#if this.showLoader}}
  <WebComponents::AuLoadingOverlay/>
{{/if}}